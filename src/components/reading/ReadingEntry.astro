---
import { toMonthYear, toReadableString, authorToSlug } from "../../utils";
import { getUrlForCollectionEntry } from "src/content/config";
import type { CollectionEntry } from "astro:content";
import Stars from "./Stars.astro";
import BookshelfIcon from "./BookshelfIcon.astro";

export type Props = {
  post: CollectionEntry<"reading">;
  showAuthorLink?: boolean;
};

const {
  post: {
    slug,
    body,
    data: { title, dateCompleted, author, rating },
  },
  showAuthorLink = false,
} = Astro.props;

const hasContent = body && body.trim().length > 0;
const url = hasContent ? getUrlForCollectionEntry("reading", slug) : null;
const authorUrl = showAuthorLink
  ? `/reading/author/${authorToSlug(author)}`
  : null;
---

<div class="book-entry">
  <div class="mobile-left">
    <div class="title">
      {
        hasContent ? (
          <a href={url}>{title}</a>
        ) : (
          <span class="no-review">{title}</span>
        )
      }
    </div>
    <div class="author">
      <span class="author-name">{author}</span>
      {
        authorUrl ? (
          <a
            href={authorUrl}
            class="author-link"
            aria-label={`See all reviews for books by ${author}`}
            title={`See all reviews for books by ${author}`}
          >
            <BookshelfIcon />
          </a>
        ) : null
      }
    </div>
  </div>
  <div class="mobile-right">
    <div class="date" title={toReadableString(dateCompleted)}>
      {toMonthYear(dateCompleted)}
    </div>
    <div class="rating"><Stars rating={rating} /></div>
  </div>
</div>

<style lang="scss">
  @import "/src/variables.scss";

  .book-entry {
    @include sans-serif;

    display: contents;
    .mobile-left,
    .mobile-right {
      display: contents;
    }

    .title,
    .author {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .author {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .author-name {
      // Ensure author name is not clickable
    }

    .author-link {
      display: inline-flex;
      align-items: center;
      text-decoration: none;
      color: $accent-color;
      opacity: 0.7;
      transition:
        opacity 0.2s,
        color 0.2s;
      border-radius: 5px;

      &:hover,
      &:focus {
        opacity: 1;
        color: $text-color;
      }

      &:focus:not(:focus-visible) {
        outline: none;
      }
    }

    .date {
      @include dimmed;
    }

    .no-review {
      font-style: italic;
    }

    @media #{$media-size-phone} {
      .mobile-left,
      .mobile-right {
        display: flex;
        gap: 0.25rem;
      }
      .mobile-left {
        flex-direction: column;
        justify-content: space-around;
      }
      .mobile-right {
        flex-direction: column-reverse;
        justify-content: space-evenly;
      }

      .title,
      .author {
        white-space: normal;
      }

      .author {
        font-size: 0.9rem;
      }
    }
  }
</style>
